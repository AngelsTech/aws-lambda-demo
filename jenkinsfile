pipeline {
    agent any

    environment {
        FUNCTION_NAME = 'hello-world-lambda'
        REGION = 'us-east-1'
        ZIP_FILE = 'lambda.zip'
    }

    stages {
      stage('Clone Repository') {
            steps {
                git branch: 'checkout scmGit(branches: [[name: '*/main']], extensions: [], userRemoteConfigs: [[credentialsId: '66142c87-d271-41f4-82d1-cbbee8e844d0', url: 'https://github.com/AngelsTech/aws-lambda-demo.git']])'
            }
        }

        stage('Prepare') {
            steps {
                script {
                    sh 'zip -r lambda.zip lambda_function.py'
                }
            }
        }

        stage('Deploy Lambda') {
            steps {
                script {
                    sh '''
                        aws lambda create-function \
                        --function-name $FUNCTION_NAME \
                        --runtime python3.13 \
                        --role arn:aws:iam::529088259986:role/service-role/mylambda-s3-access \
                        --handler lambda_function.lambda_handler \
                        --zip-file fileb://$ZIP_FILE \
                        --region $REGION || true

                        aws lambda update-function-code \
                        --function-name $FUNCTION_NAME \
                        --zip-file fileb://$ZIP_FILE \
                        --region $REGION
                    '''
                }
            }
        }

        stage('Setup CloudWatch Schedule') {
            steps {
                script {
                    sh '''
                        aws events put-rule \
                        --schedule-expression "rate(15 minutes)" \
                        --name hello-schedule \
                        --region $REGION

                        aws lambda add-permission \
                        --function-name $FUNCTION_NAME \
                        --statement-id hello-event \
                        --action 'lambda:InvokeFunction' \
                        --principal events.amazonaws.com \
                        --source-arn arn:aws:events:$REGION:arn:aws:lambda:us-east-1:529088259986:function:hello-world-lambda:rule/hello-schedule \
                        --region $REGION || true

                        aws events put-targets \
                        --rule hello-schedule \
                        --targets "Id"="1","Arn"="arn:aws:lambda:$REGION:arn:aws:lambda:us-east-1:529088259986:function:hello-world-lambda:function:$FUNCTION_NAME"
                    '''
                }
            }
        }
    }
